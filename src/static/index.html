<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIT Emerging Talent LMS - Interactive Pseudocode Editor</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #252526;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .user-info {
            position: absolute;
            top: 1rem;
            right: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info span {
            opacity: 0.9;
        }

        .login-container {
            max-width: 400px;
            margin: 5rem auto;
            background: #252526;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h2 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .project-selector {
            background: #2d2d30;
            padding: 1rem 2rem;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .project-dropdown {
            flex: 1;
            max-width: 300px;
        }

        .toolbar {
            background: #2d2d30;
            padding: 1rem 2rem;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #007acc;
            color: white;
        }

        .btn-primary:hover {
            background: #005a9e;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .content {
            padding: 2rem;
        }

        .section {
            margin-bottom: 1.5rem;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            overflow: hidden;
        }

        .section-header {
            background: #37373d;
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.3s ease;
            user-select: none;
        }

        .section-header:hover {
            background: #404045;
        }

        .section-header.expanded {
            background: #404045;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .section-icon {
            font-size: 0.9rem;
            transition: transform 0.3s ease;
        }

        .section-header.expanded .section-icon {
            transform: rotate(90deg);
        }

        .section-actions {
            display: flex;
            gap: 0.5rem;
        }

        .section-content {
            display: none;
            padding: 1.5rem;
            background: #2d2d30;
        }

        .section-content.expanded {
            display: block;
        }

        .subsection {
            margin-left: 2rem;
            margin-bottom: 1rem;
            border-left: 2px solid #007acc;
            padding-left: 1rem;
        }

        .item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #3e3e42;
            transition: background 0.3s ease;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item:hover {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }

        .item-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .item-text {
            flex: 1;
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .item:hover .item-actions {
            opacity: 1;
        }

        .priority-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-critical {
            background: #dc3545;
            color: white;
        }

        .priority-high {
            background: #fd7e14;
            color: white;
        }

        .priority-medium {
            background: #ffc107;
            color: #212529;
        }

        .priority-low {
            background: #6c757d;
            color: white;
        }

        .comment {
            background: #2d4a22;
            border-left: 4px solid #28a745;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            font-style: italic;
        }

        .ux-decision {
            background: #3d2914;
            border-left: 4px solid #ffc107;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 4px;
        }

        .add-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #1a472a;
            border: 2px dashed #28a745;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .add-item:hover {
            background: #1e5e2e;
            border-color: #34ce57;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }

        .modal-content {
            background-color: #252526;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 80%;
            max-width: 600px;
            border: 1px solid #3e3e42;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #3e3e42;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #fff;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #d4d4d4;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        select.form-control {
            cursor: pointer;
        }

        .search-box {
            flex: 1;
            max-width: 300px;
        }

        .stats {
            display: flex;
            gap: 2rem;
            margin-left: auto;
            font-size: 0.9rem;
            color: #9cdcfe;
        }

        .breadcrumb {
            background: #37373d;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid #3e3e42;
            font-size: 0.9rem;
            color: #9cdcfe;
        }

        .breadcrumb a {
            color: #9cdcfe;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            color: #fff;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #9cdcfe;
        }

        .error {
            background: #3d1a1a;
            border: 1px solid #dc3545;
            color: #dc3545;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats {
                margin-left: 0;
                margin-top: 1rem;
            }
            
            .subsection {
                margin-left: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginContainer" class="login-container">
        <div class="login-header">
            <h2><i class="fas fa-code"></i> MIT Emerging Talent LMS</h2>
            <p>Interactive Pseudocode Editor</p>
        </div>
        
        <div id="loginForm">
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" id="loginUsername" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="loginPassword" class="form-control" required>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn btn-primary" onclick="login()" style="flex: 1;">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <button type="button" class="btn btn-secondary" onclick="showRegisterForm()" style="flex: 1;">
                    <i class="fas fa-user-plus"></i> Register
                </button>
            </div>
        </div>

        <div id="registerForm" class="hidden">
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" id="registerUsername" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="registerEmail" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="registerPassword" class="form-control" required>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn btn-success" onclick="register()" style="flex: 1;">
                    <i class="fas fa-user-plus"></i> Register
                </button>
                <button type="button" class="btn btn-secondary" onclick="showLoginForm()" style="flex: 1;">
                    <i class="fas fa-arrow-left"></i> Back to Login
                </button>
            </div>
        </div>

        <div id="loginError" class="error hidden"></div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container hidden">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-code"></i> MIT Emerging Talent LMS</h1>
            <p>Interactive Pseudocode Editor & Requirements Manager</p>
            <div class="user-info">
                <span id="currentUser">Welcome, User!</span>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Project Selector -->
        <div class="project-selector">
            <div class="project-dropdown">
                <select id="projectSelect" class="form-control" onchange="loadProject()">
                    <option value="">Select a project...</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="showNewProjectModal()">
                <i class="fas fa-plus"></i> New Project
            </button>
            <button class="btn btn-danger" onclick="deleteCurrentProject()" id="deleteProjectBtn" disabled>
                <i class="fas fa-trash"></i> Delete Project
            </button>
            <button class="btn btn-warning" onclick="showProjectSettings()" id="projectSettingsBtn" disabled>
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>

        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <i class="fas fa-home"></i> 
            <span id="breadcrumbPath">Select a project to get started</span>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <button class="btn btn-primary" onclick="expandAll()">
                <i class="fas fa-expand-arrows-alt"></i> Expand All
            </button>
            <button class="btn btn-secondary" onclick="collapseAll()">
                <i class="fas fa-compress-arrows-alt"></i> Collapse All
            </button>
            <button class="btn btn-success" onclick="exportPseudocode()">
                <i class="fas fa-download"></i> Export
            </button>
            <button class="btn btn-warning" onclick="showStats()">
                <i class="fas fa-chart-bar"></i> Statistics
            </button>
            
            <input type="text" class="form-control search-box" placeholder="Search pseudocode..." 
                   onkeyup="searchPseudocode(this.value)">
            
            <div class="stats">
                <span><i class="fas fa-list"></i> <span id="totalItems">0</span> Items</span>
                <span><i class="fas fa-exclamation-triangle"></i> <span id="criticalItems">0</span> Critical</span>
                <span><i class="fas fa-question-circle"></i> <span id="uxDecisions">0</span> UX Decisions</span>
            </div>
        </div>

        <!-- Content -->
        <div class="content" id="pseudocodeContent">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> Select a project to view its content
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Project</h3>
                <span class="close" onclick="closeNewProjectModal()">&times;</span>
            </div>
            <div class="form-group">
                <label class="form-label">Project Name</label>
                <input type="text" id="newProjectName" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Description (Optional)</label>
                <textarea id="newProjectDescription" class="form-control" rows="3"></textarea>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeNewProjectModal()">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createProject()">Create Project</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Item</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="itemForm">
                <div class="form-group">
                    <label class="form-label">Item Text</label>
                    <input type="text" id="itemText" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select id="itemPriority" class="form-control">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select id="itemType" class="form-control">
                        <option value="feature">Feature</option>
                        <option value="comment">Comment</option>
                        <option value="ux-decision">UX Decision</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description (Optional)</label>
                    <textarea id="itemDescription" class="form-control" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Item</button>
                    <button type="button" class="btn btn-success" onclick="closeModal()" id="saveCloseBtn" style="display: none;">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Section Modal -->
    <div id="sectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="sectionModalTitle">Add New Section</h3>
                <span class="close" onclick="closeSectionModal()">&times;</span>
            </div>
            <form id="sectionForm">
                <div class="form-group">
                    <label class="form-label">Section Name</label>
                    <input type="text" id="sectionName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select id="sectionPriority" class="form-control">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeSectionModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Section</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentProject = null;
        let projectData = null;
        let expandedSections = new Set();
        let currentSection = null;
        let currentSubsection = null;
        let currentEditingItem = null;
        let currentEditingSection = null;
        let keepModalOpen = false; // Flag to prevent modal closing

        // API helper functions
        async function apiCall(endpoint, options = {}) {
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            const response = await fetch(`/api${endpoint}`, {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({ error: 'Network error' }));
                throw new Error(error.error || `HTTP ${response.status}`);
            }

            return response.json();
        }

        // Authentication functions
        async function login() {
            console.log('Login function called');
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            console.log('Username:', username, 'Password length:', password.length);

            if (!username || !password) {
                console.log('Missing username or password');
                showError('Please enter both username and password');
                return;
            }

            try {
                console.log('Making API call to /auth/login');
                const user = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                console.log('Login successful, user:', user);

                currentUser = user;
                document.getElementById('currentUser').textContent = `Welcome, ${user.username}!`;
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                await loadProjects();
            } catch (error) {
                console.error('Login error:', error);
                showError(error.message);
            }
        }

        async function register() {
            console.log('Register function called');
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            console.log('Username:', username, 'Email:', email, 'Password length:', password.length);

            if (!username || !email || !password) {
                console.log('Missing required fields');
                showError('Please fill in all fields');
                return;
            }

            try {
                console.log('Making API call to /auth/register');
                const user = await apiCall('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ username, email, password })
                });
                console.log('Registration successful, user:', user);

                currentUser = user;
                document.getElementById('currentUser').textContent = `Welcome, ${user.username}!`;
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                await loadProjects();
            } catch (error) {
                console.error('Registration error:', error);
                showError(error.message);
            }
        }

        async function logout() {
            try {
                await apiCall('/auth/logout', { method: 'POST' });
                currentUser = null;
                currentProject = null;
                projectData = null;
                
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginContainer').classList.remove('hidden');
                showLoginForm();
                clearForms();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            hideError();
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            hideError();
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('loginError').classList.add('hidden');
        }

        function clearForms() {
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('registerUsername').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
        }

        // Project management functions
        async function loadProjects() {
            try {
                const projects = await apiCall('/projects');
                const select = document.getElementById('projectSelect');
                
                select.innerHTML = '<option value="">Select a project...</option>';
                
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading projects:', error);
                showToast('Error loading projects: ' + error.message, 'error');
            }
        }

        async function loadProject() {
            const projectId = document.getElementById('projectSelect').value;
            
            if (!projectId) {
                currentProject = null;
                projectData = null;
                document.getElementById('breadcrumbPath').textContent = 'Select a project to get started';
                document.getElementById('pseudocodeContent').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Select a project to view its content</div>';
                document.getElementById('projectSettingsBtn').disabled = true;
                document.getElementById('deleteProjectBtn').disabled = true;
                return;
            }

            try {
                projectData = await apiCall(`/projects/${projectId}`);
                currentProject = projectData;
                
                document.getElementById('breadcrumbPath').textContent = `Project: ${projectData.name}`;
                document.getElementById('projectSettingsBtn').disabled = false;
                document.getElementById('deleteProjectBtn').disabled = false;
                
                renderPseudocode();
                updateStats();
            } catch (error) {
                console.error('Error loading project:', error);
                showToast('Error loading project: ' + error.message, 'error');
            }
        }

        function showNewProjectModal() {
            document.getElementById('newProjectName').value = '';
            document.getElementById('newProjectDescription').value = '';
            document.getElementById('newProjectModal').style.display = 'block';
        }

        function closeNewProjectModal() {
            document.getElementById('newProjectModal').style.display = 'none';
        }

        async function createProject() {
            const name = document.getElementById('newProjectName').value;
            const description = document.getElementById('newProjectDescription').value;

            if (!name) {
                showToast('Please enter a project name', 'error');
                return;
            }

            try {
                const project = await apiCall('/projects', {
                    method: 'POST',
                    body: JSON.stringify({ name, description })
                });

                closeNewProjectModal();
                await loadProjects();
                
                // Select the new project
                document.getElementById('projectSelect').value = project.id;
                await loadProject();
                
                showToast('Project created successfully', 'success');
            } catch (error) {
                showToast('Error creating project: ' + error.message, 'error');
            }
        }

        // Rendering functions
        function renderPseudocode() {
            if (!projectData || !projectData.sections) {
                document.getElementById('pseudocodeContent').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> No sections found</div>';
                return;
            }

            const contentDiv = document.getElementById('pseudocodeContent');
            contentDiv.innerHTML = '';

            // Add "Add Section" button
            const addSectionButton = document.createElement('div');
            addSectionButton.className = 'add-item';
            addSectionButton.onclick = () => showAddSectionModal();
            addSectionButton.innerHTML = `
                <i class="fas fa-plus"></i>
                <span>Add New Section</span>
            `;
            contentDiv.appendChild(addSectionButton);

            // Render sections
            projectData.sections.forEach(section => {
                const sectionElement = createSectionElement(section);
                contentDiv.appendChild(sectionElement);
            });
        }

        function createSectionElement(section) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section';
            sectionDiv.id = `section-${section.id}`;

            const headerDiv = document.createElement('div');
            headerDiv.className = 'section-header';
            headerDiv.onclick = () => toggleSection(section.id);

            const titleDiv = document.createElement('div');
            titleDiv.className = 'section-title';
            titleDiv.innerHTML = `
                <i class="fas fa-chevron-right section-icon"></i>
                <span>${section.name}</span>
                <span class="priority-badge priority-${section.priority}">${section.priority}</span>
            `;

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'section-actions';
            actionsDiv.innerHTML = `
                <button class="btn btn-success btn-sm" onclick="addItem(${section.id}, null, event)">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="btn btn-warning btn-sm" onclick="editSection(${section.id}, event)">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteSection(${section.id}, event)">
                    <i class="fas fa-trash"></i>
                </button>
            `;

            headerDiv.appendChild(titleDiv);
            headerDiv.appendChild(actionsDiv);

            const contentDiv = document.createElement('div');
            contentDiv.className = 'section-content';
            contentDiv.id = `content-${section.id}`;

            // Render items
            if (section.items && section.items.length > 0) {
                section.items.forEach(item => {
                    const itemElement = createItemElement(item, section.id);
                    contentDiv.appendChild(itemElement);
                });
            }

            // Add "Add Item" button
            const addItemButton = document.createElement('div');
            addItemButton.className = 'add-item';
            addItemButton.onclick = () => addItem(section.id);
            addItemButton.innerHTML = `
                <i class="fas fa-plus"></i>
                <span>Add Item</span>
            `;
            contentDiv.appendChild(addItemButton);

            sectionDiv.appendChild(headerDiv);
            sectionDiv.appendChild(contentDiv);

            return sectionDiv;
        }

        function createItemElement(item, sectionId, parentItemId = null) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item';

            // Create main container for side-by-side layout
            const mainContainer = document.createElement('div');
            mainContainer.style.display = 'flex';
            mainContainer.style.width = '100%';
            mainContainer.style.alignItems = 'flex-start';
            mainContainer.style.gap = '1rem';

            // Left side - main item content
            const leftSide = document.createElement('div');
            leftSide.style.flex = '1';
            leftSide.style.minWidth = '0';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'item-content';

            const textDiv = document.createElement('div');
            textDiv.className = 'item-text';
            
            let itemClass = '';
            if (item.type === 'comment') itemClass = 'comment';
            else if (item.type === 'ux-decision') itemClass = 'ux-decision';

            textDiv.innerHTML = `
                <div class="${itemClass}">
                    ${item.text}
                    ${item.description ? `<br><small style="opacity: 0.8;">${item.description}</small>` : ''}
                </div>
            `;

            const priorityBadge = document.createElement('span');
            priorityBadge.className = `priority-badge priority-${item.priority}`;
            priorityBadge.textContent = item.priority;

            contentDiv.appendChild(textDiv);
            contentDiv.appendChild(priorityBadge);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'item-actions';
            actionsDiv.innerHTML = `
                <button class="btn btn-success btn-sm" onclick="addChildItem(${sectionId}, ${item.id}, event)">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="btn btn-warning btn-sm" onclick="editItem(${sectionId}, ${item.id}, ${parentItemId}, event)">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteItem(${sectionId}, ${item.id}, ${parentItemId}, event)">
                    <i class="fas fa-trash"></i>
                </button>
            `;

            leftSide.appendChild(contentDiv);
            leftSide.appendChild(actionsDiv);
            mainContainer.appendChild(leftSide);

            // Right side - children (if they exist)
            if (item.children && item.children.length > 0) {
                // Add vertical separator
                const separator = document.createElement('div');
                separator.innerHTML = '|';
                separator.style.color = '#007acc';
                separator.style.fontSize = '1.5rem';
                separator.style.fontWeight = 'bold';
                separator.style.alignSelf = 'stretch';
                separator.style.display = 'flex';
                separator.style.alignItems = 'center';
                mainContainer.appendChild(separator);

                // Right side container for children
                const rightSide = document.createElement('div');
                rightSide.style.flex = '1';
                rightSide.style.minWidth = '0';
                
                item.children.forEach((child, index) => {
                    const childElement = createItemElement(child, sectionId, item.id);
                    childElement.style.marginBottom = '0.5rem';
                    rightSide.appendChild(childElement);
                });

                // Add "Add Child Item" button
                const addChildButton = document.createElement('div');
                addChildButton.className = 'add-item';
                addChildButton.onclick = () => addChildItem(sectionId, item.id);
                addChildButton.innerHTML = `
                    <i class="fas fa-plus"></i>
                    <span>Add Child Item</span>
                `;
                rightSide.appendChild(addChildButton);

                mainContainer.appendChild(rightSide);
            }

            itemDiv.appendChild(mainContainer);
            return itemDiv;
        }

        // Section management functions
        function showAddSectionModal() {
            currentEditingSection = null;
            document.getElementById('sectionModalTitle').textContent = 'Add New Section';
            document.getElementById('sectionName').value = '';
            document.getElementById('sectionPriority').value = 'medium';
            document.getElementById('sectionModal').style.display = 'block';
        }

        function closeSectionModal() {
            document.getElementById('sectionModal').style.display = 'none';
        }

        async function editSection(sectionId, event) {
            if (event) event.stopPropagation();
            
            const section = projectData.sections.find(s => s.id === sectionId);
            if (!section) return;

            currentEditingSection = sectionId;
            document.getElementById('sectionModalTitle').textContent = 'Edit Section';
            document.getElementById('sectionName').value = section.name;
            document.getElementById('sectionPriority').value = section.priority;
            document.getElementById('sectionModal').style.display = 'block';
        }

        async function deleteSection(sectionId, event) {
            if (event) event.stopPropagation();
            
            if (!confirm('Are you sure you want to delete this section and all its items?')) {
                return;
            }

            try {
                await apiCall(`/sections/${sectionId}`, { method: 'DELETE' });
                await loadProject(); // Reload the project
                showToast('Section deleted successfully', 'success');
            } catch (error) {
                showToast('Error deleting section: ' + error.message, 'error');
            }
        }

        // Handle section form submission
        document.getElementById('sectionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('sectionName').value;
            const priority = document.getElementById('sectionPriority').value;

            if (!name) {
                showToast('Please enter a section name', 'error');
                return;
            }

            try {
                if (currentEditingSection) {
                    // Update existing section
                    await apiCall(`/sections/${currentEditingSection}`, {
                        method: 'PUT',
                        body: JSON.stringify({ name, priority })
                    });
                    showToast('Section updated successfully', 'success');
                } else {
                    // Create new section
                    await apiCall(`/projects/${currentProject.id}/sections`, {
                        method: 'POST',
                        body: JSON.stringify({ name, priority })
                    });
                    showToast('Section created successfully', 'success');
                }

                closeSectionModal();
                await loadProject(); // Reload the project
            } catch (error) {
                showToast('Error saving section: ' + error.message, 'error');
            }
        });

        // Item management functions
        function addItem(sectionId, parentItemId = null, event = null) {
            if (event) event.stopPropagation();
            
            currentSection = sectionId;
            currentSubsection = parentItemId;
            currentEditingItem = null;
            
            document.getElementById('modalTitle').textContent = parentItemId ? 'Add Child Items' : 'Add New Items';
            document.getElementById('itemText').value = '';
            document.getElementById('itemPriority').value = 'medium';
            document.getElementById('itemType').value = 'feature';
            document.getElementById('itemDescription').value = '';
            
            // Show close button for adding multiple items
            document.getElementById('saveCloseBtn').style.display = 'inline-block';
            
            document.getElementById('itemModal').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('itemText').focus();
            }, 100);
        }

        function addChildItem(sectionId, parentItemId, event = null) {
            addItem(sectionId, parentItemId, event);
        }

        async function editItem(sectionId, itemId, parentItemId = null, event = null) {
            if (event) event.stopPropagation();
            
            // Find the item in the project data
            let item = null;
            for (const section of projectData.sections) {
                if (section.id === sectionId) {
                    if (parentItemId) {
                        // Find parent item first
                        const parentItem = section.items.find(i => i.id === parentItemId);
                        if (parentItem && parentItem.children) {
                            item = parentItem.children.find(i => i.id === itemId);
                        }
                    } else {
                        item = section.items.find(i => i.id === itemId);
                    }
                    break;
                }
            }

            if (!item) return;

            currentSection = sectionId;
            currentSubsection = parentItemId;
            currentEditingItem = itemId;
            
            document.getElementById('modalTitle').textContent = 'Edit Item';
            document.getElementById('itemText').value = item.text;
            document.getElementById('itemPriority').value = item.priority;
            document.getElementById('itemType').value = item.type;
            document.getElementById('itemDescription').value = item.description || '';
            
            // Hide close button when editing (will close automatically after save)
            document.getElementById('saveCloseBtn').style.display = 'none';
            
            document.getElementById('itemModal').style.display = 'block';
            
            setTimeout(() => {
                const textInput = document.getElementById('itemText');
                textInput.focus();
                textInput.select();
            }, 100);
        }

        async function deleteItem(sectionId, itemId, parentItemId = null, event = null) {
            if (event) event.stopPropagation();
            
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }

            try {
                await apiCall(`/items/${itemId}`, { method: 'DELETE' });
                await loadProject(); // Reload the project
                showToast('Item deleted successfully', 'success');
            } catch (error) {
                showToast('Error deleting item: ' + error.message, 'error');
            }
        }

        // Handle item form submission
        document.getElementById('itemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const text = document.getElementById('itemText').value;
            const priority = document.getElementById('itemPriority').value;
            const type = document.getElementById('itemType').value;
            const description = document.getElementById('itemDescription').value;

            if (!text) {
                showToast('Please enter item text', 'error');
                return;
            }

            try {
                if (currentEditingItem) {
                    // Update existing item - close modal after editing
                    await apiCall(`/items/${currentEditingItem}`, {
                        method: 'PUT',
                        body: JSON.stringify({ text, priority, type, description })
                    });
                    showToast('Item updated successfully', 'success');
                    closeModal();
                    await loadProject(); // Only reload for edits
                } else {
                    // Create new item - use localStorage to persist modal state
                    const modalState = {
                        isOpen: true,
                        section: currentSection,
                        subsection: currentSubsection,
                        priority: priority,
                        type: type
                    };
                    localStorage.setItem('modalState', JSON.stringify(modalState));
                    
                    if (currentSubsection) {
                        // Create child item
                        await apiCall(`/sections/${currentSection}/items`, {
                            method: 'POST',
                            body: JSON.stringify({ text, priority, type, description, parent_id: currentSubsection })
                        });
                    } else {
                        // Create top-level item
                        await apiCall(`/sections/${currentSection}/items`, {
                            method: 'POST',
                            body: JSON.stringify({ text, priority, type, description })
                        });
                    }
                    showToast('✅ Item added! Add another or click Close', 'success');
                    
                    // Clear form for next item
                    document.getElementById('itemText').value = '';
                    document.getElementById('itemDescription').value = '';
                    
                    // Reload project but restore modal afterwards
                    await loadProject();
                    
                    // Restore modal state from localStorage
                    const savedState = localStorage.getItem('modalState');
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        if (state.isOpen) {
                            currentSection = state.section;
                            currentSubsection = state.subsection;
                            currentEditingItem = null;
                            
                            document.getElementById('modalTitle').textContent = state.subsection ? 'Add Child Items' : 'Add New Items';
                            document.getElementById('itemText').value = '';
                            document.getElementById('itemPriority').value = state.priority;
                            document.getElementById('itemType').value = state.type;
                            document.getElementById('itemDescription').value = '';
                            document.getElementById('saveCloseBtn').style.display = 'inline-block';
                            document.getElementById('itemModal').style.display = 'block';
                            
                            setTimeout(() => {
                                document.getElementById('itemText').focus();
                            }, 100);
                        }
                    }
                }
            } catch (error) {
                localStorage.removeItem('modalState'); // Clear on error
                showToast('Error saving item: ' + error.message, 'error');
            }
        });

        // Utility functions
        function toggleSection(sectionId) {
            const header = document.querySelector(`#section-${sectionId} .section-header`);
            const content = document.getElementById(`content-${sectionId}`);
            
            header.classList.toggle('expanded');
            content.classList.toggle('expanded');
            
            if (header.classList.contains('expanded')) {
                expandedSections.add(`section-${sectionId}`);
            } else {
                expandedSections.delete(`section-${sectionId}`);
            }
        }

        function expandAll() {
            document.querySelectorAll('.section-header').forEach(header => {
                header.classList.add('expanded');
                const sectionId = header.closest('.section').id;
                expandedSections.add(sectionId);
            });
            document.querySelectorAll('.section-content').forEach(content => {
                content.classList.add('expanded');
            });
        }

        function collapseAll() {
            document.querySelectorAll('.section-header').forEach(header => {
                header.classList.remove('expanded');
                const sectionId = header.closest('.section').id;
                expandedSections.delete(sectionId);
            });
            document.querySelectorAll('.section-content').forEach(content => {
                content.classList.remove('expanded');
            });
        }

        function closeModal() {
            document.getElementById('itemModal').style.display = 'none';
            
            // Clear modal state from localStorage
            localStorage.removeItem('modalState');
            
            // Reload project to show any new items that were added
            if (currentProject) {
                loadProject();
            }
        }

        function searchPseudocode(query) {
            const items = document.querySelectorAll('.item');
            let visibleCount = 0;
            
            items.forEach(item => {
                const text = item.querySelector('.item-text').textContent.toLowerCase();
                if (text.includes(query.toLowerCase()) || query === '') {
                    item.style.display = 'flex';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            if (query.trim() !== '') {
                expandAll();
                if (visibleCount === 0) {
                    showToast('No items found matching your search', 'warning');
                } else {
                    showToast(`Found ${visibleCount} items matching "${query}"`, 'info');
                }
            }
        }

        function updateStats() {
            if (!projectData || !projectData.sections) {
                document.getElementById('totalItems').textContent = '0';
                document.getElementById('criticalItems').textContent = '0';
                document.getElementById('uxDecisions').textContent = '0';
                return;
            }

            let totalItems = 0;
            let criticalItems = 0;
            let uxDecisions = 0;
            
            function countItems(items) {
                items.forEach(item => {
                    totalItems++;
                    if (item.priority === 'critical') criticalItems++;
                    if (item.type === 'ux-decision') uxDecisions++;
                    if (item.children) countItems(item.children);
                });
            }
            
            projectData.sections.forEach(section => {
                if (section.items) {
                    countItems(section.items);
                }
            });
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('criticalItems').textContent = criticalItems;
            document.getElementById('uxDecisions').textContent = uxDecisions;
        }

        async function exportPseudocode() {
            if (!currentProject) {
                showToast('Please select a project first', 'warning');
                return;
            }

            try {
                // Use current project data instead of calling non-existent API endpoint
                const exportData = {
                    project: currentProject,
                    exportedAt: new Date().toISOString(),
                    sections: projectData.sections || []
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${currentProject.name.replace(/\s+/g, '-').toLowerCase()}-pseudocode.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                showToast('Project exported successfully', 'success');
            } catch (error) {
                showToast('Error exporting project: ' + error.message, 'error');
            }
        }

        async function deleteCurrentProject() {
            if (!currentProject) {
                showToast('Please select a project first', 'warning');
                return;
            }

            const confirmDelete = confirm(`Are you sure you want to delete "${currentProject.name}"?\n\nThis will permanently delete:\n- All sections\n- All items\n- All project data\n\nThis action cannot be undone!`);
            
            if (!confirmDelete) {
                return;
            }

            try {
                await apiCall(`/projects/${currentProject.id}`, {
                    method: 'DELETE'
                });
                
                showToast('Project deleted successfully', 'success');
                
                // Clear current project
                currentProject = null;
                projectData = null;
                
                // Reload projects list
                await loadProjects();
                
                // Clear the main content
                document.getElementById('projectContent').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i> Select a project to view its content
                    </div>
                `;
                
                // Disable buttons
                document.getElementById('deleteProjectBtn').disabled = true;
                document.getElementById('projectSettingsBtn').disabled = true;
                
            } catch (error) {
                showToast('Error deleting project: ' + error.message, 'error');
            }
        }

        function showProjectSettings() {
            if (!currentProject) {
                showToast('Please select a project first', 'warning');
                return;
            }

            // Simple settings dialog for now
            const newName = prompt('Project Name:', currentProject.name);
            if (newName && newName.trim() && newName !== currentProject.name) {
                updateProjectSettings(newName.trim());
            }
        }

        async function updateProjectSettings(newName) {
            try {
                const updatedProject = await apiCall(`/projects/${currentProject.id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ 
                        name: newName,
                        description: currentProject.description 
                    })
                });
                
                currentProject.name = newName;
                document.getElementById('breadcrumbPath').textContent = `Project: ${newName}`;
                
                // Update project dropdown
                const option = document.querySelector(`#projectSelect option[value="${currentProject.id}"]`);
                if (option) {
                    option.textContent = newName;
                }
                
                showToast('Project settings updated successfully', 'success');
            } catch (error) {
                showToast('Error updating project settings: ' + error.message, 'error');
            }
        }

        function showStats() {
            if (!projectData) {
                showToast('Please select a project first', 'warning');
                return;
            }

            const totalItems = document.getElementById('totalItems').textContent;
            const criticalItems = document.getElementById('criticalItems').textContent;
            const uxDecisions = document.getElementById('uxDecisions').textContent;
            const sections = projectData.sections ? projectData.sections.length : 0;

            alert(`
Project Statistics:
- Total Items: ${totalItems}
- Critical Items: ${criticalItems}
- UX Decisions: ${uxDecisions}
- Sections: ${sections}
            `);
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s ease;
                max-width: 300px;
            `;
            
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#007acc'
            };
            toast.style.backgroundColor = colors[type] || colors.info;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = ['itemModal', 'newProjectModal', 'sectionModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Check if user is already logged in
                const user = await apiCall('/auth/me');
                currentUser = user;
                document.getElementById('currentUser').textContent = `Welcome, ${user.username}!`;
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                await loadProjects();
            } catch (error) {
                // User not logged in, show login form
                document.getElementById('loginContainer').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });
    </script>
</body>
</html>

